apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: mlflow-minio
  namespace: opifex-mlops
  labels:
    app.kubernetes.io/name: minio
    app.kubernetes.io/component: object-storage
    app.kubernetes.io/instance: mlflow-minio
  annotations:
    opifex.framework/description: "MinIO object storage for MLflow artifacts and scientific datasets"
    opifex.framework/artifact-types: "models,datasets,checkpoints,experiments,plots"
    opifex.framework/retention-policy: "90d"
spec:
  serviceName: mlflow-minio-headless
  replicas: 4 # 4-node MinIO cluster for high availability
  selector:
    matchLabels:
      app.kubernetes.io/name: minio
      app.kubernetes.io/instance: mlflow-minio
  template:
    metadata:
      labels:
        app.kubernetes.io/name: minio
        app.kubernetes.io/component: object-storage
        app.kubernetes.io/instance: mlflow-minio
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9090"
        prometheus.io/path: "/minio/v2/metrics/cluster"
    spec:
      serviceAccountName: mlflow-minio
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
      containers:
        - name: minio
          image: minio/minio:RELEASE.2024-01-16T16-07-38Z
          imagePullPolicy: IfNotPresent
          command:
            - /bin/bash
            - -c
          args:
            - |
              minio server \
                http://mlflow-minio-{0...3}.mlflow-minio-headless.opifex-mlops.svc.cluster.local/data \
                --console-address ":9001" \
                --address ":9000"
          env:
            - name: MINIO_ROOT_USER
              valueFrom:
                secretKeyRef:
                  name: mlops-secrets
                  key: MINIO_ROOT_USER
            - name: MINIO_ROOT_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: mlops-secrets
                  key: MINIO_ROOT_PASSWORD
            - name: MINIO_PROMETHEUS_AUTH_TYPE
              value: "public"
            - name: MINIO_PROMETHEUS_URL
              value: "http://prometheus.monitoring.svc.cluster.local:9090"
            # Scientific computing optimizations
            - name: MINIO_API_REQUESTS_MAX
              value: "10000"
            - name: MINIO_API_REQUESTS_DEADLINE
              value: "10s"
            - name: MINIO_SCANNER_DELAY
              value: "10s"
            # Large file optimizations for scientific datasets
            - name: MINIO_API_SYNC_EVENTS
              value: "on"
          ports:
            - name: minio-api
              containerPort: 9000
              protocol: TCP
            - name: minio-console
              containerPort: 9001
              protocol: TCP
          resources:
            requests:
              memory: "2Gi"
              cpu: "1000m"
            limits:
              memory: "8Gi"
              cpu: "4000m"
          livenessProbe:
            httpGet:
              path: /minio/health/live
              port: minio-api
              scheme: HTTP
            initialDelaySeconds: 30
            timeoutSeconds: 10
            periodSeconds: 30
            successThreshold: 1
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /minio/health/ready
              port: minio-api
              scheme: HTTP
            initialDelaySeconds: 10
            timeoutSeconds: 5
            periodSeconds: 10
            successThreshold: 1
            failureThreshold: 3
          startupProbe:
            httpGet:
              path: /minio/health/live
              port: minio-api
              scheme: HTTP
            initialDelaySeconds: 10
            timeoutSeconds: 5
            periodSeconds: 10
            successThreshold: 1
            failureThreshold: 12
          volumeMounts:
            - name: minio-data
              mountPath: /data
            - name: minio-config
              mountPath: /etc/minio
              readOnly: true
      volumes:
        - name: minio-config
          configMap:
            name: minio-config
  volumeClaimTemplates:
    - metadata:
        name: minio-data
        labels:
          app.kubernetes.io/name: minio
          app.kubernetes.io/instance: mlflow-minio
      spec:
        accessModes:
          - ReadWriteOnce
        resources:
          requests:
            storage: 500Gi
        storageClassName: fast-ssd
