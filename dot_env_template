# SciML Environment Configuration - GPU Enabled
# Auto-generated by unified setup script

# CUDA Library Configuration - Use local venv CUDA installation
# Point to locally installed CUDA libraries in venv
# Use absolute path for the project directory (will be replaced during setup)
PROJECT_DIR="/media/mahdi/ssd23/Works/SciML"

# Dynamically detect Python version using venv's Python or fallback to common versions
if [ -f "${PROJECT_DIR}/.venv/bin/python" ]; then
    PYTHON_VERSION=$("${PROJECT_DIR}/.venv/bin/python" -c "import sys; print(f'python{sys.version_info.major}.{sys.version_info.minor}')" 2>/dev/null)
elif [ -d "${PROJECT_DIR}/.venv/lib/python3.12" ]; then
    PYTHON_VERSION="python3.12"
elif [ -d "${PROJECT_DIR}/.venv/lib/python3.11" ]; then
    PYTHON_VERSION="python3.11"
elif [ -d "${PROJECT_DIR}/.venv/lib/python3.10" ]; then
    PYTHON_VERSION="python3.10"
else
    # Fallback: detect by looking at what exists in .venv/lib/
    PYTHON_VERSION=$(ls -d "${PROJECT_DIR}/.venv/lib/python3."* 2>/dev/null | head -1 | xargs basename 2>/dev/null || echo "python3.10")
fi
VENV_CUDA_BASE="${PROJECT_DIR}/.venv/lib/${PYTHON_VERSION}/site-packages/nvidia"

# Filter out old CUDA paths from existing LD_LIBRARY_PATH and preserve other paths
# This removes any paths containing 'nvidia', 'cuda', 'cudnn', 'nccl', etc.
if [ -n "$LD_LIBRARY_PATH" ]; then
    FILTERED_LD_PATH=$(echo "$LD_LIBRARY_PATH" | tr ':' '\n' | grep -v -E '(nvidia|cuda|cudnn|nccl|cublas|cusolver|cusparse|cufft|curand|nvjitlink)' | tr '\n' ':' | sed 's/:$//')
else
    FILTERED_LD_PATH=""
fi

# Set new CUDA paths and append filtered existing paths
NEW_CUDA_PATHS="${VENV_CUDA_BASE}/cublas/lib:${VENV_CUDA_BASE}/cusolver/lib:${VENV_CUDA_BASE}/cusparse/lib:${VENV_CUDA_BASE}/cudnn/lib:${VENV_CUDA_BASE}/cufft/lib:${VENV_CUDA_BASE}/curand/lib:${VENV_CUDA_BASE}/nccl/lib:${VENV_CUDA_BASE}/nvjitlink/lib:${VENV_CUDA_BASE}/cuda_runtime/lib:${VENV_CUDA_BASE}/cuda_nvrtc/lib:${VENV_CUDA_BASE}/cuda_cupti/lib:${VENV_CUDA_BASE}/nvtx/lib:${VENV_CUDA_BASE}/cuda_nvcc/bin"

if [ -n "$FILTERED_LD_PATH" ]; then
    export LD_LIBRARY_PATH="${NEW_CUDA_PATHS}:${FILTERED_LD_PATH}"
else
    export LD_LIBRARY_PATH="${NEW_CUDA_PATHS}"
fi

# Set CUDA_HOME to point to venv CUDA installation
export CUDA_HOME="${VENV_CUDA_BASE}"
export CUDA_PATH="${VENV_CUDA_BASE}"

# Ensure venv CUDA binaries are in PATH
export PATH="${VENV_CUDA_BASE}/cuda_nvcc/bin:${PATH}"

# Force CUDA to use venv libraries only
export CUDA_CACHE_DISABLE="1"
export CUDA_MODULE_LOADING="LAZY"

# JAX Configuration for CUDA
export JAX_PLATFORMS="cuda,cpu"
export XLA_PYTHON_CLIENT_PREALLOCATE="false"
export XLA_PYTHON_CLIENT_MEM_FRACTION="0.8"
export XLA_FLAGS="--xla_gpu_strict_conv_algorithm_picker=false"

# JAX CUDA Plugin Configuration
export JAX_CUDA_PLUGIN_VERIFY="false"
# export JAX_SKIP_CUDA_CONSTRAINTS_CHECK="1"  # Disabled to catch CUDA version mismatches

# Reduce CUDA warnings
export TF_CPP_MIN_LOG_LEVEL="1"

# Performance settings
export JAX_ENABLE_X64="0"

# Development settings
export PYTHONPATH="${PYTHONPATH:+${PYTHONPATH}:}${PROJECT_DIR}"

# Testing configuration
export PYTEST_CUDA_ENABLED="true"

# Protobuf Configuration to fix compatibility issues
export PROTOCOL_BUFFERS_PYTHON_IMPLEMENTATION="python"

# Cache Configuration
export XLA_CACHE_DIR="${PROJECT_DIR}/.cache/xla"
export JAX_COMPILATION_CACHE_DIR="${PROJECT_DIR}/.cache/jax"

# Ensure cache directories exist
mkdir -p "${PROJECT_DIR}/.cache/xla" 2>/dev/null || true
mkdir -p "${PROJECT_DIR}/.cache/jax" 2>/dev/null || true

# SciML-specific Configuration
export SCIML_BENCHMARK_CACHE_DIR="${PROJECT_DIR}/benchmark_results"
export SCIML_DATA_DIR="${PROJECT_DIR}/data"
export SCIML_CHECKPOINT_DIR="${PROJECT_DIR}/checkpoints"

# Ensure SciML directories exist
mkdir -p "${PROJECT_DIR}/benchmark_results" 2>/dev/null || true
mkdir -p "${PROJECT_DIR}/data" 2>/dev/null || true
mkdir -p "${PROJECT_DIR}/checkpoints" 2>/dev/null || true

# GPU Memory Management
export GPU_MEMORY_FRACTION="0.8"
export CUDA_VISIBLE_DEVICES="0"

# Development Mode Settings
export SCIML_DEV_MODE="1"
export SCIML_LOG_LEVEL="INFO"

# Verification marker - indicates this environment is properly configured
export SCIML_ENV_CONFIGURED="1"
